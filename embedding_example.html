<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superset åµŒå…¥ç¤ºä¾‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .iframe-container {
            margin: 20px 0;
            border: 2px solid #007bff;
            border-radius: 8px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            border: none;
            display: block;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .step {
            counter-increment: step-counter;
            position: relative;
        }
        .step::before {
            content: "æ­¥éª¤ " counter(step-counter) ": ";
            font-weight: bold;
            color: #007bff;
        }
        .container {
            counter-reset: step-counter;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Superset åµŒå…¥åŠŸèƒ½ç¤ºä¾‹</h1>
        
        <div class="status success">
            âœ… <strong>é…ç½®çŠ¶æ€:</strong> Superset åµŒå…¥åŠŸèƒ½å·²æˆåŠŸé…ç½®å¹¶å¯ç”¨ï¼ç°åœ¨æ”¯æŒä»»ä½•åŸŸçš„ iframe åµŒå…¥ï¼
        </div>
        
        <div class="section">
            <h2>ğŸ“‹ é…ç½®æ¦‚è§ˆ</h2>
            <p>æ‚¨çš„ Superset å®ä¾‹å·²é…ç½®äº†ä»¥ä¸‹åµŒå…¥åŠŸèƒ½ï¼š</p>
            <ul>
                <li>âœ… åµŒå…¥å¼å›¾è¡¨ (EMBEDDABLE_CHARTS)</li>
                <li>âœ… åµŒå…¥å¼ä»ªè¡¨æ¿ (EMBEDDABLE_DASHBOARDS)</li>
                <li>âœ… åŸç”Ÿè¿‡æ»¤å™¨ (DASHBOARD_NATIVE_FILTERS)</li>
                <li>âœ… äº¤å‰è¿‡æ»¤å™¨ (DASHBOARD_CROSS_FILTERS)</li>
                <li>âœ… CORS è·¨åŸŸæ”¯æŒ</li>
                <li>âœ… JWT è®¤è¯</li>
                <li>âœ… Guest Token æ”¯æŒ</li>
            </ul>
        </div>

        <div class="section">
            <h2 class="step">è·å– Guest Token</h2>
            <p>åœ¨åµŒå…¥å†…å®¹ä¹‹å‰ï¼Œæ‚¨éœ€è¦è·å– Guest Tokenï¼š</p>
            
            <div class="code-block">
# 1. è·å– CSRF Token
curl -c cookies.txt http://localhost:8088/api/v1/security/csrf_token/

# 2. è·å– Guest Token
curl -b cookies.txt -X POST \
  http://localhost:8088/api/v1/security/guest_token/ \
  -H "Content-Type: application/json" \
  -H "X-CSRFToken: YOUR_CSRF_TOKEN" \
  -d '{
    "user": {"username": "guest"},
    "resources": [{"type": "dashboard", "id": "1"}],
    "rls": []
  }'
            </div>
            
            <button onclick="testGuestToken()">æµ‹è¯• Guest Token API</button>
            <div id="token-result"></div>
        </div>

        <div class="section">
            <h2 class="step">åµŒå…¥ä»ªè¡¨æ¿ç¤ºä¾‹</h2>
            <p>ä½¿ç”¨ iframe åµŒå…¥ä»ªè¡¨æ¿ï¼ˆéœ€è¦å…ˆåˆ›å»ºä»ªè¡¨æ¿ï¼‰ï¼š</p>
            
            <div class="code-block">
&lt;iframe
  src="http://localhost:8088/superset/dashboard/p/1/?standalone=3&guest_token=YOUR_GUEST_TOKEN"
  width="100%"
  height="600"
  frameborder="0"&gt;
&lt;/iframe&gt;
            </div>
            
            <div class="status warning">
                âš ï¸ <strong>æ³¨æ„:</strong> æ‚¨éœ€è¦å…ˆåœ¨ Superset ä¸­åˆ›å»ºä»ªè¡¨æ¿ï¼Œç„¶åè·å–å…¶ ID æ¥æµ‹è¯•åµŒå…¥åŠŸèƒ½ã€‚
            </div>
        </div>

        <div class="section">
            <h2 class="step">åµŒå…¥å›¾è¡¨ç¤ºä¾‹</h2>
            <p>ä½¿ç”¨ iframe åµŒå…¥å•ä¸ªå›¾è¡¨ï¼š</p>
            
            <div class="code-block">
&lt;iframe
  src="http://localhost:8088/superset/explore/p/1/?standalone=1&guest_token=YOUR_GUEST_TOKEN"
  width="100%"
  height="400"
  frameborder="0"&gt;
&lt;/iframe&gt;
            </div>
        </div>

        <div class="section">
            <h2 class="step">æµ‹è¯•åŸºæœ¬è¿æ¥</h2>
            <p>é¦–å…ˆæµ‹è¯• Superset æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š</p>
            
            <div class="iframe-container">
                <iframe src="http://localhost:8088/health" height="100"></iframe>
            </div>
            
            <button onclick="openSuperset()">æ‰“å¼€ Superset ç™»å½•é¡µé¢</button>
            <button onclick="checkHealth()">æ£€æŸ¥å¥åº·çŠ¶æ€</button>
            <div id="health-result"></div>
        </div>

        <div class="section">
            <h2>ğŸ”§ æ•…éšœæ’é™¤</h2>
            <div class="status info">
                <strong>å¸¸è§é—®é¢˜:</strong>
                <ul>
                    <li><strong>CORS é”™è¯¯:</strong> æ£€æŸ¥ CORS_OPTIONS é…ç½®ä¸­çš„ origins è®¾ç½®</li>
                    <li><strong>âœ… X-Frame-Options é”™è¯¯:</strong> å·²è§£å†³ï¼X-Frame-Options å¤´éƒ¨å·²è¢«ç§»é™¤ï¼Œæ”¯æŒä»»ä½•åŸŸåµŒå…¥</li>
                    <li><strong>è®¤è¯å¤±è´¥:</strong> éªŒè¯ Guest Token çš„ç”Ÿæˆå’Œä½¿ç”¨</li>
                    <li><strong>404 é”™è¯¯:</strong> ç¡®è®¤ä»ªè¡¨æ¿æˆ–å›¾è¡¨çš„ ID æ˜¯å¦æ­£ç¡®</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“š ä¸‹ä¸€æ­¥</h2>
            <ol>
                <li>ç™»å½• Superset: <a href="http://localhost:8088" target="_blank">http://localhost:8088</a> (admin/admin)</li>
                <li>è¿æ¥æ‚¨çš„ MS SQL Server æ•°æ®åº“</li>
                <li>åˆ›å»ºæ•°æ®é›†å’Œå›¾è¡¨</li>
                <li>åˆ›å»ºä»ªè¡¨æ¿</li>
                <li>ä½¿ç”¨ Guest Token API ç”ŸæˆåµŒå…¥ä»¤ç‰Œ</li>
                <li>åœ¨æ‚¨çš„åº”ç”¨ä¸­åµŒå…¥ Superset å†…å®¹</li>
            </ol>
        </div>
    </div>

    <script>
        function openSuperset() {
            window.open('http://localhost:8088', '_blank');
        }

        async function checkHealth() {
            const resultDiv = document.getElementById('health-result');
            resultDiv.innerHTML = '<p>æ£€æŸ¥ä¸­...</p>';
            
            try {
                const response = await fetch('http://localhost:8088/health');
                if (response.ok) {
                    const text = await response.text();
                    resultDiv.innerHTML = `
                        <div class="status success">
                            âœ… <strong>å¥åº·æ£€æŸ¥æˆåŠŸ!</strong> çŠ¶æ€: ${response.status}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status warning">
                            âš ï¸ <strong>å¥åº·æ£€æŸ¥å¤±è´¥:</strong> çŠ¶æ€ ${response.status}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status warning">
                        âŒ <strong>è¿æ¥å¤±è´¥:</strong> ${error.message}
                        <br>è¯·ç¡®ä¿ Superset æ­£åœ¨è¿è¡Œåœ¨ http://localhost:8088
                    </div>
                `;
            }
        }

        async function testGuestToken() {
            const resultDiv = document.getElementById('token-result');
            resultDiv.innerHTML = '<p>æµ‹è¯•ä¸­...</p>';
            
            try {
                // é¦–å…ˆè·å– CSRF Token
                const csrfResponse = await fetch('http://localhost:8088/api/v1/security/csrf_token/', {
                    credentials: 'include'
                });
                
                if (csrfResponse.status === 401) {
                    resultDiv.innerHTML = `
                        <div class="status info">
                            â„¹ï¸ <strong>CSRF Token API éœ€è¦è®¤è¯</strong>
                            <br>è¿™æ˜¯æ­£å¸¸çš„ï¼Œè¯·å…ˆç™»å½• Superset åå†æµ‹è¯• Guest Token åŠŸèƒ½ã€‚
                            <br><a href="http://localhost:8088" target="_blank">ç‚¹å‡»è¿™é‡Œç™»å½• Superset</a>
                        </div>
                    `;
                } else if (csrfResponse.ok) {
                    const csrfData = await csrfResponse.json();
                    resultDiv.innerHTML = `
                        <div class="status success">
                            âœ… <strong>CSRF Token è·å–æˆåŠŸ!</strong>
                            <br>Token é•¿åº¦: ${csrfData.result.length}
                            <br>ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨æ­¤ Token æ¥è·å– Guest Tokenã€‚
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status warning">
                            âš ï¸ <strong>CSRF Token è·å–å¤±è´¥:</strong> çŠ¶æ€ ${csrfResponse.status}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status warning">
                        âŒ <strong>æµ‹è¯•å¤±è´¥:</strong> ${error.message}
                        <br>è¯·ç¡®ä¿ Superset æ­£åœ¨è¿è¡Œåœ¨ http://localhost:8088
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥å¥åº·çŠ¶æ€
        window.onload = function() {
            checkHealth();
        };
    </script>
</body>
</html> 
